<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="CGJSD">
	<select id="CGJSD_JX_DX_SR" parameterType="Map" resultType="java.util.Map">
		<if test="HZFS == 0 ">
		Select A.SPXX01,S.SPXX02 SPBM,S.SPXX04 SPMC,S.JLDW01 JLDW,S.GGB01 SPGG,to_char(A.JXSP12,'YYYY-MM-DD') DJRQ,
		      A.JXSP01 DJH01, 
		     <!--   GET_JLWBDH(A.JXSP01,A.GSXX01,A.JXSP02)WBDH,-->
		      GET_JLWBDH(A.JXSP02,A.JXSP01, A.GSXX01 ) WBDH,
		      A.JXSP02 DJLX,GET_DJLX(A.JXSP02) DJLXMC, A.JXSP03 PCH, A.JXSP04 PCXH, round(A.JXSP07,2) WSDJ,
			   round(A.JXSP08,2) HSDJ,A.JXSP05 DJSL,NVL(A.JXSP15,0) SHDH,to_char(A.JXSP13,'YYYY-MM-DD') JZRQ,
			   A.CGXY01 CGXYH01,0 DXKL,0 LYKL,A.BM01 XS_BM01,(SELECT BM02 FROM BM WHERE BM.BM01 = A.BM01) XSBMMC,
			   (A.JXSP05 - A.JXSP06 - A.JXSP14 - A.JXSP16) WKPSL,round((A.JXSP05 * A.JXSP08),2) DJJE
		  From JXSPJSB A, SPXX S
		 Where 1=1  
			<if test="SPMC != null and SPMC != ''">
	         	AND (REGEXP_LIKE(S.SPXX02, #{SPMC}, 'i') OR REGEXP_LIKE(S.SPXX04, #{SPMC}, 'i') OR REGEXP_LIKE(S.SPPYM, #{SPMC}, 'i'))
	        </if>
	        <if test="DJH01 != null and DJH01 != ''">
	        	 AND GET_JLWBDH(A.JXSP02,A.JXSP01, A.GSXX01 ) =#{DJH01}
	        </if>
	        <if test="DJLX != null and DJLX != ''">
				AND GET_DJLX(A.JXSP02) = #{DJLX}
			</if>
			 <![CDATA[
			AND A.SPXX01 = S.SPXX01 And ABS(A.JXSP05 - A.JXSP06 - A.JXSP14 - A.JXSP16) >= 0.005
			AND A.GSXX01 =#{GSXX01} 
			AND A.WLDW01 =#{WLDW01} 
			AND A.BM01 =#{BM01}
			AND A.JXSP12 >= TO_DATE(#{JSQSRQ},'YYYY-MM-DD') 
		    AND A.JXSP12 <= TO_DATE(#{JSZZRQ},'YYYY-MM-DD')	
			 ]]>
			ORDER BY A.SPXX01, A.JXSP02, A.JXSP01 
		</if>
		<if test="HZFS == 1 or HZFS == 2 or HZFS == 3 ">
		SELECT A.SPXX01,S.SPXX02 SPBM,S.SPXX04 SPMC,S.JLDW01 JLDW,S.GGB01 SPGG,to_char(A.SPPCXS01,'YYYY-MM-DD') DJRQ,
	           A.DJBH DJH01,
	         <!--  GET_JLWBDH(A.DJBH,A.GSXX01,A.SPPCXS14) WBDH,  --> 
	             GET_JLWBDH(djly,substr(A.DJBH,0,length(A.DJBH)-2), A.GSXX01 ) WBDH,
	           A.SPPCXS14 DJLX, CASE WHEN A.SPPCXS14 = 0 THEN '销售' ELSE GET_DJLX(A.SPPCXS14) END DJLXMC,
	           round(A.SPPCXS05,2) WSDJ,round(A.SPPCXS05 * (1 + W.JXSL01),2) HSDJ,round(SUM(A.SPPCXS07),2) DJJE,
			   SUM(A.SPPCXS06 - GYSFPGDSL01) DJSL,A.XSBM XS_BM01,
			   SUM(A.SPPCXS06 - A.SPPCXS13 - A.SPPCXS15 - A.SPPCXS16) WKPSL,
			   (SELECT BM02 FROM BM WHERE BM01 = A.XSBM) XSBMMC,A.SPPCXS02 PCH,A.SPPCXS03 PCXH,
			   A.SPPCXS12 LYKL,A.SPPCXS11 CGXYH01
	      FROM SPPCXSR A, SPXX S, WLDW W  
		 WHERE A.SPXX01 = S.SPXX01 AND A.WLDW01 = W.WLDW01 
		    <if test="SPMC != null and SPMC != ''">
	         	AND (REGEXP_LIKE(S.SPXX02, #{SPMC}, 'i') OR REGEXP_LIKE(S.SPXX04, #{SPMC}, 'i') OR REGEXP_LIKE(S.SPPYM, #{SPMC}, 'i'))
	        </if>
	        <if test="DJH01 != null and DJH01 != ''">
	         	AND A.DJBH =#{DJH01}
	        </if>
	        <if test="DJLX != null and DJLX != ''">
				AND GET_DJLX(A.SPPCXS14) = #{DJLX}
			</if>
		<![CDATA[
		   AND ABS(A.SPPCXS06 - A.SPPCXS13 - A.SPPCXS15 - A.SPPCXS16) >= 0.005 
		   AND A.GSXX01 = #{GSXX01} 
		   AND A.WLDW01 = #{WLDW01} 
		   AND A.BM01 = #{BM01} 
		   AND A.SPPCXS04 = #{HZFS} 
		   AND A.SPPCXS01 >= TO_DATE(#{JSQSRQ},'YYYY-MM-DD') 
		   AND A.SPPCXS01 <= TO_DATE(#{JSZZRQ},'YYYY-MM-DD')			   
	   GROUP BY A.SPXX01,S.SPXX02,S.SPXX04,S.SPXH01,S.GGB01,S.PPB02,S.SPXX26,S.SPXX33,
          A.BM01,A.BJLX01,A.XSBM,A.WLDW01,A.SPPCXS02,A.SPPCXS03,W.WLDW02,W.JXSL01,
          A.GHHT01,A.SPPCXS12,A.SPPCXS11,A.SPPCXS14,A.SPPCXS05,A.SPPCXS01,A.DJLY,
          A.DJBH,S.JLDW01,A.GSXX01 
      HAVING ABS(SUM(A.SPPCXS06 - A.SPPCXS13 - A.SPPCXS15 - A.SPPCXS16)) >= 0.005 
	  ORDER BY A.SPXX01, A.XSBM 
   			]]>
   		</if>
	</select>

	<select id="CGJSD_SR" parameterType="Map" resultType="java.util.Map">
		 Select 
		 <!-- A.JSSRD01, A.JSSRD14 JSDJSR03, A.JSSRD15 JSDJSR04, B.JSSRDI01, B.JSSR01, C.JSSR02, 
		 B.CGXY02, A.JSSRD11, A.JSSRD08 JSDJSR05, A.JSSRD12 JSDJSR06, B.JSSRDI02, B.JSSRDI05, A.BM01, 
		 (Select BM02 From BM Where BM01 = A.BM01) BM02, (B.JSSRDI10 - B.JSSRDI11 + B.JSSRDI12 - 
		 B.PKJE - B.JSSRDI07) KYJE  -->
		 A.JLWBDH SRDH,A.JSSRD01 SRD01,B.JSSRDI01 SDRXH,B.JSSR01,C.JSSR02 JSSRMC, 
         (B.JSSRDI10 - B.JSSRDI11 + B.JSSRDI12 - B.PKJE - B.JSSRDI07) WHXJE,
         TO_CHAR(A.JSSRD14,'YYYY-MM-DD') QSRQ,TO_CHAR(A.JSSRD15,'YYYY-MM-DD') ZZRQ
		 From JSSRD A, JSSRDITEM B, JSSRDM C 
		 Where A.GSXX01 = B.GSXX01 And A.JSSRD01 = B.JSSRD01 And A.JSSRD08 Is Not Null 
		 And B.JSSR01 = C.JSSR01
		  <![CDATA[
		 And ABS(B.JSSRDI10 - B.JSSRDI11 + B.JSSRDI12 - B.PKJE - B.JSSRDI07) >= 0.005 
		  AND A.JSSRD08 >= TO_DATE(#{JSQSRQ},'YYYY-MM-DD') 
		  AND A.JSSRD08 <= TO_DATE(#{JSZZRQ},'YYYY-MM-DD')
		 ]]>
		 AND A.GSXX01 = #{GSXX01} 
		 AND A.WLDW01 = #{WLDW01}  
		 AND A.BM01 = #{BM01} 
		 
		 <if test="HZFS != null">
		   AND (CASE A.JSSRD11 WHEN 2 THEN B.JSSRDI21 ELSE A.JSSRD13 END) = #{HZFS}
		 </if>  
		 ORDER BY A.JSSRD01, JSSRDI01 
	</select>
</mapper>