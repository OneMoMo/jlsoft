<script type="text/javascript">
var commonQuery = JL.JLForm();

commonQuery.setAfterInit(function(){
	var sqlMap = JLQuery["config"]["sqlMap"];
	
	commonQuery.getTab().find(".modal_content").css({"height": "90%", "max-height": "90%"});
	
	if(!JL.isNull(sqlMap.title)){
		commonQuery.getTab().find(".modal_title > h3").html(sqlMap.title);
	}

	var buttons = [{
		text:"查找",
		icon:"search",
		func:function(){
			commonQuery.query();
		}
	},{
		text:"确定",
		icon:"gavel",
		func:function(){
			commonQuery.callback();
		}
	}];
	var queryGridConfig = {
		"jlid": "JLGrid",
		"obj": commonQuery.getTab(),
		"sequence": false,
		"multi": true,
		"paging":"more",
		"height": 348,
		"headers": sqlMap.result,
		"buttons": buttons,
		"listener": {
			"loadRow": function(thisPlugin, data, index, dl){
				if(!JL.isNull(sqlMap.listener) && JL.isFunction(sqlMap.listener.loadRow)){
					sqlMap.listener.loadRow(thisPlugin, data, index, dl);
				}
			},
			"rowdblclick": function(thisPlugin, data, index, dl){
				if(!JL.isNull(sqlMap.listener) && JL.isFunction(sqlMap.listener.rowdblclick)){
					var rdblc = sqlMap.listener.rowdblclick(thisPlugin, data, index, dl);
					if(rdblc){
						return false;
					}
				}
				commonQuery.callback();
			},
			"rowclick" : function(thisPlugin, data, index, dl){
				if(!JL.isNull(sqlMap.listener) && JL.isFunction(sqlMap.listener.rowclick)){
					sqlMap.listener.rowclick(thisPlugin, data, index, dl);
				}
			},
			"checked" : function(thisPlugin, rowIndex, bool){
				if(!JL.isNull(sqlMap.listener) && JL.isFunction(sqlMap.listener.checked)){
					sqlMap.listener.checked(thisPlugin, rowIndex, bool);
				}
			}
		}
	};
	if(!JLQuery["config"]["multi"]){
		queryGridConfig.multi = false;
	}
	
	if(!JL.isNull(sqlMap.interfaceId) || !JL.isNull(sqlMap.url)){
		queryGridConfig.paging = "local";
		queryGridConfig.pagesize = "50";
	}
	
	if(!JL.isNull(sqlMap.queryGrid)){
		$.extend(queryGridConfig, sqlMap.queryGrid);
	}
	
	var pluginObj = JL.initPlugIn(commonQuery.getTab().find("#d_querygrid"), "querygrid", queryGridConfig, null, null, null, commonQuery)
	commonQuery.setPluginObj({"querygrid": pluginObj});
	
	if(!JL.isNull(sqlMap.page)){
		commonQuery.getTab().find("#queryField").show();
		commonQuery.getTab().find("#queryField").load(sqlMap.page+"?rid"+JL.random(), function(){
			var height = commonQuery.getTab().find(".modal_content").height() - 54 - commonQuery.getTab().find(".jl_screening").height();
			if(!JL.isNull(commonQuery.getPluginObj("querygrid").config.summary)){
				height -= 40;
			}
			if(!commonQuery.getPluginObj("querygrid").obj.find(".table_scrollbar").is(":hidden")){
				height -= 14;
			}
			commonQuery.getPluginObj("querygrid").setHeight(height);
			
			if(!JL.isNull(sqlMap) && !JL.isNull(sqlMap.queryField)){
				$.each(sqlMap.queryField, function(key, value){
					if(value.enterQuery){
						commonQuery.getTab().find("[name='"+key+"']").keyup(function(e){
							if(e.keyCode == 13){
								commonQuery.query();
							}
						});
					}
				});
			}
		});
	}
	
	if(!JL.isNull(JLQuery["config"]["autoquery"])){
		commonQuery.query();
	}
});

commonQuery.query = function(json){
	commonQuery.readData();
	var data = commonQuery.getData();
	delete data["querygrid"];
	delete data["jlbh"];
	var sqlMap = JLQuery["config"]["sqlMap"];

	var XmlData = JLQuery["config"]["modalField"];
	$.extend(XmlData, data);
	if(!JL.isNull(json)){
		$.extend(XmlData, json);
	}
	$.extend(XmlData, userInfo);
	
	delete XmlData["querygrid"];
	delete XmlData["jlbh"];
	$.each(XmlData, function(key, value){
		if(typeof value == "object"){
			if($.isArray(value)){
				if(value.length > 0){
					if(typeof value[0] == "object"){
						var arr = [];
						for(var i=0;i<value.length;i++){
							arr.push(value[i]["key"]);
						}
						XmlData[key] = arr;
					}
				}else{
					delete XmlData[key]; 
				}
			}else if(!JL.isNull(value.key)){
				XmlData[key] = value.key;
			}else{
				delete XmlData[key]; 
			}
		}
	});
	
	XmlData["dataType"] = "Json";
	XmlData["sqlid"] = sqlMap.sqlid;
	XmlData["DataBaseType"] = sqlMap.DataBaseType;
	
	if(!JL.isNull(sqlMap.isNotNull)){
		var num = 0;
		$.each(sqlMap.isNotNull, function(key, value){
			if(JL.isNull(XmlData[key])){
				JL.tip(value, "info");
				num++;
				return false;
			}
		});
		if(num > 0){
			return false;
		}
	}
	
	if(JL.isFunction(sqlMap.before)){
		if(sqlMap.before(XmlData)){
			return false;
		}
	}

	if(JLQuery["config"]["resultData"] != null && typeof JLQuery["config"]["resultData"] != "undefined"){
		commonQuery.getPluginObj("querygrid").setData(JLQuery["config"]["resultData"]);
	}else{
		var ajaxJson = {};
		if(!JL.isNull(sqlMap.url)){
			ajaxJson["src"] = sqlMap.url;
			ajaxJson["data"] = {"XmlData":JSON.stringify(XmlData)};
		}else if(!JL.isNull(sqlMap.interfaceId)){
			commonQuery.getPluginObj("querygrid").config.interfaceQuery = commonQuery.query;
			ajaxJson["src"] = pubJson.getURL("FormUrl") + "/Inbound/dispatch.do?rid="+Math.random();
			if(JL.isNull(XmlData.PAGENUM)){
				XmlData["PAGENUM"] = 1;
			}
			ajaxJson["data"] = {"interfaceId":sqlMap.interfaceId, "data":JSON.stringify(XmlData)};
		}else if(!JL.isNull(sqlMap.collection)){
			XmlData["collection"] = sqlMap.collection;
			XmlData["sort"] = sqlMap.sort;
			XmlData["result"] = sqlMap.fields || {};
			if(sqlMap.fields == undefined){
				for (var i = 0; i < sqlMap.result.length; i++) {
					var row = sqlMap.result[i];
					XmlData["result"][row.id] = 1;
				}
			}
			ajaxJson["src"] = pubJson.getURL("FormUrl") + "/jlquery/selectMongo.do?rid="+Math.random();
			ajaxJson["data"] = {"XmlData":JSON.stringify(XmlData)};
		}else{
			ajaxJson["src"] = pubJson.getURL("FormUrl") + "/jlquery/select.do?rid="+Math.random();
			XmlData["QryType"] = "Report";
			ajaxJson["data"] = {"XmlData":JSON.stringify(XmlData)};
			
			//返回数据length 及最大页数
			JLMessage.unbind("1003").bind("1003", function(data, param){
				console.info(data);
				var grid = param.form.getPluginObj("querygrid");
				grid.setLastPaging(data.LASTPAGE);
			}, {
				"form":this
			});
		}
		commonQuery.getPluginObj("querygrid").data=[];
		commonQuery.getPluginObj("querygrid").removeAll();
		commonQuery.getPluginObj("querygrid").paging.currentPage = 1;
		var resultData = JL.ajax(ajaxJson,true);
		if(!JL.isNull(resultData)){
			if(typeof resultData == "object" && !$.isArray(resultData)){
				if(resultData.MSGID == "E" && resultData.MESSAGE != undefined){
					JL.tip(resultData.MESSAGE, "info");
					return false;
				}
				var fileName = resultData.fileName;
				resultData = resultData.data;
				if(!JL.isNull(resultData) && resultData.resultlist != undefined){
					resultData = resultData.resultlist;
				}
				if(JL.isNull(sqlMap.interfaceId) && JL.isNull(sqlMap.url)){
					commonQuery.getPluginObj("querygrid").setPaging(fileName);
					var getLastPage = function(){
						setTimeout(function(){
							debugger;
							var grid = commonQuery.getPluginObj("querygrid");
							if(grid.obj.find(".title_right .fa-spinner").length > 0){
								var lastPage = JL.getPagingData(fileName, "LASTPAGE");
								if(!JL.isNull(lastPage)){
									grid.obj.find(".title_right .fa-spinner").parent().html("<i class='fa fa-mail-forward mr5'></i>导出数据");
									grid.setLastPaging(lastPage);
								}else{
									getLastPage();
								}
							}
						}, 10000)
					}
					getLastPage();
				}
			}
			if(resultData.length == 0){
				JL.tip("未查到相关数据");
			}
			commonQuery.getPluginObj("querygrid").setData(resultData);
		}else if($.isArray(resultData) && resultData.length == 0){
			JL.tip("未查到相关数据");
			return false;
		}
	}
}

commonQuery.callback = function(){
	var list = commonQuery.getPluginObj("querygrid").getSelected();
	JLQuery.close(list);
}
</script>
<div class="max_modal_main">
	<div class="modal_title"><h3>查找</h3><span>×</span></div>
	<div class="modal_content">
		<div id="queryField" class="w12 jl_screening hide">
    		<ul><li class="w12"></li></ul>
  		</div>
		<div id="customPage"></div>
        <!--主体内容-->         
        <div id="d_querygrid" class="w12"></div>
        <div id="d_detailgrid" class="w12 hide"></div>
	</div>
</div>