<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="KHWLZZ">
	<select id="query_KHWLZZ" parameterType="java.util.Map" resultType="java.util.Map">
	    SELECT A.BM01,B.BM02,A.WLDW01,W.WLDW02,W.DQXX01,W.HYXX01,
		       (SELECT GSXX02 FROM GSXX WHERE GSXX01 = A.GSXX01) GSXX02,
		       (SELECT KSLX02 FROM KSLX WHERE KSLX01 = W.KSLX01) KSLX02,
		       (SELECT KSLB02 FROM KSLB WHERE KSLB01 = W.WLDW31) KSLB02,
		       SUM(A.SQYFYE) SQYFYE,
		       SUM(A.SQYSYE) SQYSYE,
		       SUM(A.SQYUSYE) SQYUSYE,
		       SUM(A.SQFLYE) SQFLYE,
		       SUM(A.SQBZJYE) SQBZJYE,
		       SUM(A.BQYFYE) BQYFYE,
		       SUM(A.BQYSYE) BQYSYE,
		       SUM(A.BQYUSYE) BQYUSYE,
		       SUM(A.BQFLYE) BQFLYE,
		       SUM(A.BQBZJYE) BQBZJYE,
		       SUM(A.XSJE) XSJE,
		       SUM(A.XSCB) XSCB,
		       SUM(A.XSML) XSML,
		       SUM(A.YSZJ) YSZJ,
		       SUM(A.YSJS) YSJS,
		       SUM(A.YUSZJ) YUSZJ,
		       SUM(A.YUSJS) YUSJS,
		       SUM(A.FLZJ) FLZJ,
		       SUM(A.FLJS) FLJS,
		       SUM(A.YFFH) YFFH,
		       SUM(A.YFYJ) YFYJ,
		       SUM(A.YFSJ) YFSJ,
		       SUM(A.YFTH) YFTH,
		       SUM(A.XSTH) XSTH,
		       SUM(A.PFZK) PFZK,
		       SUM(A.XSSL) XSSL,
		       SUM(A.XSJE - A.YSZJ + A.YSJS) KHHKJE,
		       SUM(A.YFSL) YFSL,
		       SUM(A.PFBJSL) PFBJSL,
		       SUM(A.PFBJJE) PFBJJE,
		       NVL(SUM(A.SQYFYE) + SUM(A.SQYSYE) - SUM(A.SQYUSYE), 0) SQYE,
		       NVL(SUM(A.SQYFYE) + SUM(A.SQYSYE) - SUM(A.SQYUSYE) - SUM(A.SQFLYE),0) SQKCFLYE,
		       NVL(SUM(A.BQYFYE) + SUM(A.BQYSYE) - SUM(A.BQYUSYE), 0) BQYE,
		       NVL(SUM(A.BQYFYE) + SUM(A.BQYSYE) - SUM(A.BQYUSYE) - SUM(A.BQFLYE),0) BQKCFLYE
		  FROM V_KHXSR_HZ A, BM B, WLDW W
		 WHERE A.BM01 = B.BM01
		   AND A.WLDW01 = W.WLDW01
		   AND A.GSXX01 = #{GSXX01}
		   <![CDATA[ 
  		   		AND ((A.MINDATE = TO_DATE(#{RQQ}, 'yyyy-mm-dd') AND A.MAXDATE IS NULL) OR
		        	 (A.MINDATE > TO_DATE(#{RQQ}, 'yyyy-mm-dd') AND A.MAXDATE <= TO_DATE(#{RQZ}, 'yyyy-mm-dd')) OR
		        	 (A.MINDATE IS NULL AND A.MAXDATE = TO_DATE(#{RQZ}, 'yyyy-mm-dd')))
		   ]]>
		   <if test="WLDW != null and WLDW != ''">
  		   		<foreach item="item" index="index" collection="WLDW"  open=" AND (" separator=" or " close=")"> 
        			REGEXP_LIKE(W.WLDW01, #{item}, 'i') OR REGEXP_LIKE(W.WLDW02, #{item}, 'i')
         		</foreach>
  		   </if>
		   <if test="XSBMMC != null and XSBMMC != ''">
  		   		<foreach item="item" index="index" collection="XSBMMC"  open=" AND (" separator=" or " close=")"> 
        			A.BM01 = #{item}
         		</foreach>
  		   </if>
  		   JL{CZY|A.WLDW01|WLDW_CX|inS}JL
       	   JL{CZY|A.BM01|BM_CX|LIKE%}JL
		 GROUP BY A.BM01,B.BM02,A.WLDW01,W.WLDW02,W.DQXX01,W.HYXX01,W.WLDW31,A.GSXX01,W.KSLX01
  	</select>
</mapper>