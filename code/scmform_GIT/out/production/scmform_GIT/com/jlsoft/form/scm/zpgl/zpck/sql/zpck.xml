<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ZPCK">
	<!-- 赠品信息 -->
	<select id="ZPXX" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT A.SPXX01 ZPXX01,
		A.SPXX04 ZPMC,
		(CASE WHEN B.ZPCK01!=0 THEN
		round
		(B.ZPCK03/B.ZPCK01,2)
		ELSE B.ZPCK01 END) PJDJ,
		B.ZPCK01 KCKSL
		FROM SPXX
		A, ZPCKSP B
		WHERE A.SPXX17=1
		AND A.SPXX01 = B.ZPXX01
		<if test="CKBM != null and CKBM != ''">
			AND B.CK01 = #{CKBM}
		</if>
		<if test="BMBM != null and BMBM != ''">
			AND B.BM01 = #{BMBM}
		</if>
		<if test="GSXX01 != null and GSXX01 != ''">
			AND B.GSXX01 = #{GSXX01}
		</if>
		<if test="ZPXX01 != null and ZPXX01 != ''">
			AND (REGEXP_LIKE(A.SPXX02, #{ZPXX01}, 'i') OR REGEXP_LIKE(A.SPXX04, #{ZPXX01}, 'i')
				OR REGEXP_LIKE(A.SPPYM, #{ZPXX01}, 'i'))
		</if>
	</select>
	<!-- 查询赠品库存 -->
	<select id="queryZPKC" parameterType="java.util.Map" resultType="java.util.Map">
		select A.BM01 BM01,
		A.CK01 CK01,
		Z.SPXX02 ZPXX01,
		A.ZPCK01 KCSL,
		(SELECT
		max(SPJG01) FROM SPJGB WHERE SPJGB.SPXX01 = Z.SPXX01 ) ZPDJ,
		<!-- Z.ZPXX07 ZPDJ, -->
		(A.ZPCK01 * (SELECT max(SPJG01) FROM SPJGB WHERE SPJGB.SPXX01 =
		Z.SPXX01 )) JE,
		(A.ZPCK01 * (SELECT max(SPJG01) FROM SPJGB WHERE
		SPJGB.SPXX01 = Z.SPXX01 )) PJKCJE,
		CASE A.ZPCK01
		WHEN 0 THEN
		0
		ELSE
		ROUND(A.ZPCK03 / A.ZPCK01, 2)
		END PJDJ,
		A.ZPCK02 ZDWCKSL,
		(A.ZPCK01 -
		A.ZPCK02) KKDSL,
		A.ZPCK03 KCJE,
		Z.SPXX04 ZPMC,
		Z.JLDW01 JLDW,
		Z.GGB01 GG,
		C.CK02 CKMC,
		B.BM02 BMMC,
		A.GSXX01 GSXX01,
		(SELECT GSXX02 FROM GSXX WHERE
		GSXX01 = A.GSXX01) GSMC
		from ZPCKSP A, SPXX Z, CK C, BM B
		where A.ZPXX01
		= Z.SPXX01
		and A.CK01 = C.CK01
		and A.BM01 = B.BM01
		<if test="GSXX01 != null and GSXX01 != ''">
			AND A.GSXX01 = #{GSXX01}
		</if>
		<if test="BM01 != null and BM01 != ''">
			<foreach item="item" index="index" collection="BM01" open=" AND ("
				separator=" or " close=")">
				B.BM01 LIKE #{item}||'%'
			</foreach>
		</if>
		<if test="ZPXX01 != null and ZPXX01 != ''">
			<foreach item="item" index="index" collection="ZPXX01" open=" AND ("
				separator=" or " close=")">
				Upper(Z.SPXX02) LIKE Upper('%'|| #{item} ||'%') OR Upper(Z.SPXX04)
				LIKE Upper('%'||#{item}||'%')
			</foreach>
		</if>
		<if test="CK01 != null and CK01 != ''">
			<foreach item="item" index="index" collection="CK01" open=" AND ("
				separator=" or " close=")">
				C.CK01 LIKE #{item}||'%'
			</foreach>
		</if>
		JL{CZY|A.CK01|CK_CX|LIKE%}JL
		JL{CZY|A.BM01|BM_CZ|LIKE%}JL
		JL{CZY|A.GSXX01|CZGS_CZ|LIKE%}JL
	</select>
	<!--查询赠品出入库单 -->
	<select id="queryZPCK" parameterType="java.util.Map" resultType="java.util.Map">
		<if test="CRKLX == 0 ">
			<!-- 查询赠品出库单 -->
			select '出库' CRKLX,A.JLWBDH KHCYD01, S.SPXX02 SPBM, S.SPXX04 SPMC,(B.ZPCKDI01*(-1)) 
			CYSL,
			A.WLDW01 KHBM, W.WLDW02 KHMC,
			A.CK01,(SELECT CK02 FROM CK WHERE
			CK01 = A.CK01)CKMC,
			A.BM01,(SELECT BM02 FROM BM WHERE BM01 =
			A.BM01)BMMC,
			A.ZPCK03 ZDR,TO_CHAR(A.ZPCK04,'YYYY-MM-DD') ZDRQ,A.ZPCK05
			SHR,TO_CHAR(A.ZPCK06,'YYYY-MM-DD') SHRQ,A.ZPCK02 BZ
			from zpckd a,
			zpckditem b, SPXX S,WLDW W
			where a.zpck01 = b.zpck01
			and a.gsxx01 =
			b.gsxx01
			AND B.ZPXX01 = TO_CHAR(S.SPXX01)
			AND A.WLDW01 =W.WLDW01(+) 
			and A.JLWBDH
			LIKE 'ZP%'
			JL{CZY|A.CK01|CK_CX|LIKE%}JL
			JL{CZY|A.BM01|BM_CX|LIKE%}JL
			JL{CZY|A.GSXX01|CZGS_CX|LIKE%}JL
			<if test="GSXX01 != null and GSXX01 != ''">
				AND A.GSXX01 = #{GSXX01}
			</if>
			<if test="KHCYD01 != null and KHCYD01 != ''">
				AND A.JLWBDH = #{KHCYD01}
			</if>
			<if test="KH != null and KH != ''">
				<foreach item="item" index="index" collection="KH" open=" AND ("
					separator=" or " close=")">
					(W.WLDW02 LIKE '%'||#{item}||'%' OR A.WLDW01
					LIKE '%'||#{item}||'%')
				</foreach>
			</if>

			<if test="BM01 != null and BM01 != ''">
				<foreach item="item" index="index" collection="BM01" open=" AND ("
					separator=" or " close=")">
					A.BM01 LIKE #{item}||'%'
				</foreach>
			</if>

			<if test="SPMC != null and SPMC != ''">
				<foreach item="item" index="index" collection="SPMC" open=" AND ("
					separator=" or " close=")">
					 Upper(S.SPXX02) LIKE  Upper('%'||#{item}||'%') OR Upper (S.SPXX04)
					 LIKE  Upper('%'||#{item}||'%') OR
					 Upper (S.SPPYM) LIKE  Upper ('%'||#{item}||'%')
				</foreach>
			</if>
			<if test="CK01 != null and CK01 != ''">
				<foreach item="item" index="index" collection="CK01" open=" AND ("
					separator=" or " close=")">
					A.CK01 LIKE #{item}||'%'
				</foreach>
			</if>
			<if test="BZ != null and BZ != ''">
				AND A.ZPCK02 = #{BZ}
			</if>
			<if test="ZDR != null and ZDR != ''">
				AND A.ZPCK03 = #{ZDR}
			</if>
			<if test="ZDRQ_S != null and ZDRQ_S != ''">AND A.ZPCK04 &gt;= TO_DATE(#{ZDRQ_S} , 'yyyy-mm-dd ')
			</if>
			<if test="ZDRQ_E != null and ZDRQ_E != ''">AND A.ZPCK04 &lt;= TO_DATE(#{ZDRQ_E} , 'yyyy-mm-dd ')
			</if>
			<if test="SHR != null and SHR != ''">
				AND A.ZPCK05 = #{SHR}
			</if>
			<if test="SHRQ_S != null and SHRQ_S != ''">AND A.ZPCK06 &gt;= TO_DATE(#{SHRQ_S} , 'yyyy-mm-dd ')
			</if>
			<if test="SHRQ_E != null and SHRQ_E != ''">AND A.ZPCK06 &lt;= TO_DATE(#{SHRQ_E} , 'yyyy-mm-dd ')
			</if>
		</if>
		<if test="CRKLX == 1 ">
			<!-- 查询赠品入库单 -->
			select '入库'   CRKLX, A.JLWBDH KHCYD01, S.SPXX02 SPBM, S.SPXX04 SPMC,
			B.ZPRKI01 CYSL,
			A.WLDW01 KHBM,(SELECT WLDW02 FROM WLDW WHERE WLDW01=A.WLDW01) KHMC,
			A.CK01,(SELECT CK02 FROM CK WHERE CK01 = A.CK01)CKMC,
			A.BM01,(SELECT BM02 FROM BM WHERE BM01 = A.BM01)BMMC,
			A.ZPRK03 ZDR,TO_CHAR(A.ZPRK04,'YYYY-MM-DD') ZDRQ,A.ZPRK05
			SHR,TO_CHAR(A.ZPRK06,'YYYY-MM-DD') SHRQ,A.ZPRK02 BZ
			from zprkd a,
			zprkditem b, SPXX S,WLDW W
			where a.zprk01 = b.zprk01
			and a.gsxx01 = b.gsxx01
			AND B.ZPXX01 = TO_CHAR(S.SPXX01)
			AND A.WLDW01 = W.WLDW01(+)
			and A.JLWBDH LIKE 'ZP%'
			JL{CZY|A.CK01|CK_CX|LIKE%}JL
			JL{CZY|A.BM01|BM_CX|LIKE%}JL
			JL{CZY|A.GSXX01|CZGS_CX|LIKE%}JL
			<if test="GSXX01 != null and GSXX01 != ''">
				AND A.GSXX01 = #{GSXX01}
			</if>
			<if test="KHCYD01 != null and KHCYD01 != ''">
				AND A.JLWBDH = #{KHCYD01}
			</if>
			<if test="KH != null and KH != ''">
				<foreach item="item" index="index" collection="KH" open=" AND ("
					separator=" or " close=")">
					(W.WLDW02 LIKE '%'||#{item}||'%' OR A.WLDW01
					LIKE '%'||#{item}||'%')
				</foreach>
			</if>

			<if test="BM01 != null and BM01 != ''">
				<foreach item="item" index="index" collection="BM01" open=" AND ("
					separator=" or " close=")">
					A.BM01 LIKE #{item}||'%'
				</foreach>
			</if>

			<if test="SPMC != null and SPMC != ''">
				<foreach item="item" index="index" collection="SPMC" open=" AND ("
					separator=" or " close=")">
					S.SPXX02 LIKE '%'||#{item}||'%' OR S.SPXX04
					LIKE '%'||#{item}||'%' OR
					S.SPPYM LIKE '%'||#{item}||'%'
				</foreach>
			</if>
			<if test="CK01 != null and CK01 != ''">
				<foreach item="item" index="index" collection="CK01" open=" AND ("
					separator=" or " close=")">
					A.CK01 LIKE #{item}||'%'
				</foreach>
			</if>
			<if test="BZ != null and BZ != ''">
				AND A.ZPCK02 = #{BZ}
			</if>
			<if test="ZDR != null and ZDR != ''">
				AND A.ZPRK03 = #{ZDR}
			</if>
			<if test="ZDRQ_S != null and ZDRQ_S != ''">AND A.ZPRK04 &gt;= TO_DATE(#{ZDRQ_S} , 'yyyy-mm-dd ')
			</if>
			<if test="ZDRQ_E != null and ZDRQ_E != ''">AND A.ZPRK04 &lt;= TO_DATE(#{ZDRQ_E} , 'yyyy-mm-dd ')
			</if>
			<if test="SHR != null and SHR != ''">
				AND A.ZPRK05 = #{SHR}
			</if>
			<if test="SHRQ_S != null and SHRQ_S != ''">AND A.ZPRK06 &gt;= TO_DATE(#{SHRQ_S} , 'yyyy-mm-dd ')
			</if>
			<if test="SHRQ_E != null and SHRQ_E != ''">AND A.ZPRK06 &lt;= TO_DATE(#{SHRQ_E} , 'yyyy-mm-dd ')
			</if>
		</if>

	</select>
</mapper>